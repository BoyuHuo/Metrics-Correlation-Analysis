<?xml version="1.0" encoding="utf-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AbstractConverter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Apache Commons BeanUtils</a> &gt; <a href="index.source.html" class="el_package">org.apache.commons.beanutils2.converters</a> &gt; <span class="el_source">AbstractConverter.java</span></div><h1>AbstractConverter.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the &quot;License&quot;); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.apache.commons.beanutils2.converters;

import java.lang.reflect.Array;
import java.util.Collection;

import org.apache.commons.beanutils2.BeanUtils;
import org.apache.commons.beanutils2.ConversionException;
import org.apache.commons.beanutils2.ConvertUtils;
import org.apache.commons.beanutils2.Converter;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

/**
 * Base {@link Converter} implementation that provides the structure
 * for handling conversion &lt;b&gt;to&lt;/b&gt; and &lt;b&gt;from&lt;/b&gt; a specified type.
 * &lt;p&gt;
 * This implementation provides the basic structure for
 * converting to/from a specified type optionally using a default
 * value or throwing a {@link ConversionException} if a
 * conversion error occurs.
 * &lt;p&gt;
 * Implementations should provide conversion to the specified
 * type and from the specified type to a &lt;code&gt;String&lt;/code&gt; value
 * by implementing the following methods:
 * &lt;ul&gt;
 *     &lt;li&gt;&lt;code&gt;convertToString(value)&lt;/code&gt; - convert to a String
 *        (default implementation uses the objects &lt;code&gt;toString()&lt;/code&gt;
 *        method).&lt;/li&gt;
 *     &lt;li&gt;&lt;code&gt;convertToType(Class, value)&lt;/code&gt; - convert
 *         to the specified type&lt;/li&gt;
 * &lt;/ul&gt;
 * &lt;p&gt;
 * The default value has to be compliant to the default type of this
 * converter - which is enforced by the generic type parameter. If a
 * conversion is not possible and a default value is set, the converter
 * tries to transform the default value to the requested target type.
 * If this fails, a {@code ConversionException} if thrown.
 *
 * @version $Id$
 * @since 1.8.0
 */
public abstract class AbstractConverter implements Converter {

    /** Debug logging message to indicate default value configuration */
    private static final String DEFAULT_CONFIG_MSG =
        &quot;(N.B. Converters can be configured to use default values to avoid throwing exceptions)&quot;;

    /** Current package name */
    //    getPackage() below returns null on some platforms/jvm versions during the unit tests.
//    private static final String PACKAGE = AbstractConverter.class.getPackage().getName() + &quot;.&quot;;
    private static final String PACKAGE = &quot;org.apache.commons.beanutils2.converters.&quot;;

    /**
     * Logging for this instance.
     */
    private transient Log log;

    /**
     * Should we return the default value on conversion errors?
     */
<span class="fc" id="L77">    private boolean useDefault = false;</span>

    /**
     * The default value specified to our Constructor, if any.
     */
<span class="fc" id="L82">    private Object defaultValue = null;</span>

    // ----------------------------------------------------------- Constructors

    /**
     * Construct a &lt;i&gt;Converter&lt;/i&gt; that throws a
     * &lt;code&gt;ConversionException&lt;/code&gt; if an error occurs.
     */
<span class="fc" id="L90">    public AbstractConverter() {</span>
<span class="fc" id="L91">    }</span>

    /**
     * Construct a &lt;i&gt;Converter&lt;/i&gt; that returns a default
     * value if an error occurs.
     *
     * @param defaultValue The default value to be returned
     * if the value to be converted is missing or an error
     * occurs converting the value.
     */
<span class="fc" id="L101">    public AbstractConverter(final Object defaultValue) {</span>
<span class="fc" id="L102">        setDefaultValue(defaultValue);</span>
<span class="fc" id="L103">    }</span>

    // --------------------------------------------------------- Public Methods

    /**
     * Indicates whether a default value will be returned or exception
     * thrown in the event of a conversion error.
     *
     * @return &lt;code&gt;true&lt;/code&gt; if a default value will be returned for
     * conversion errors or &lt;code&gt;false&lt;/code&gt; if a {@link ConversionException}
     * will be thrown.
     */
    public boolean isUseDefault() {
<span class="fc" id="L116">        return useDefault;</span>
    }

    /**
     * Convert the input object into an output object of the
     * specified type.
     *
     * @param &lt;T&gt; the target type of the conversion
     * @param type Data type to which this value should be converted
     * @param value The input value to be converted
     * @return The converted value.
     * @throws ConversionException if conversion cannot be performed
     * successfully and no default is specified.
     */
    @Override
    public &lt;T&gt; T convert(final Class&lt;T&gt; type, Object value) {

<span class="fc bfc" id="L133" title="All 2 branches covered.">        if (type == null) {</span>
<span class="fc" id="L134">            return convertToDefaultType(type, value);</span>
        }

<span class="fc bfc" id="L137" title="All 2 branches covered.">        Class&lt;?&gt; sourceType  = value == null ? null : value.getClass();</span>
<span class="fc" id="L138">        final Class&lt;T&gt; targetType  = ConvertUtils.primitiveToWrapper(type);</span>

<span class="pc bpc" id="L140" title="1 of 2 branches missed.">        if (log().isDebugEnabled()) {</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">            log().debug(&quot;Converting&quot;</span>
<span class="nc" id="L142">                    + (value == null ? &quot;&quot; : &quot; '&quot; + toString(sourceType) + &quot;'&quot;)</span>
<span class="nc" id="L143">                    + &quot; value '&quot; + value + &quot;' to type '&quot; + toString(targetType) + &quot;'&quot;);</span>
        }

<span class="fc" id="L146">        value = convertArray(value);</span>

        // Missing Value
<span class="fc bfc" id="L149" title="All 2 branches covered.">        if (value == null) {</span>
<span class="fc" id="L150">            return handleMissing(targetType);</span>
        }

<span class="fc" id="L153">        sourceType = value.getClass();</span>

        try {
            // Convert --&gt; String
<span class="fc bfc" id="L157" title="All 2 branches covered.">            if (targetType.equals(String.class)) {</span>
<span class="fc" id="L158">                return targetType.cast(convertToString(value));</span>

            // No conversion necessary
<span class="fc bfc" id="L161" title="All 2 branches covered.">            } else if (targetType.equals(sourceType)) {</span>
<span class="pc bpc" id="L162" title="1 of 2 branches missed.">                if (log().isDebugEnabled()) {</span>
<span class="nc" id="L163">                    log().debug(&quot;    No conversion required, value is already a &quot;</span>
<span class="nc" id="L164">                                    + toString(targetType));</span>
                }
<span class="fc" id="L166">                return targetType.cast(value);</span>

            // Convert --&gt; Type
            } else {
<span class="fc" id="L170">                final Object result = convertToType(targetType, value);</span>
<span class="pc bpc" id="L171" title="1 of 2 branches missed.">                if (log().isDebugEnabled()) {</span>
<span class="nc" id="L172">                    log().debug(&quot;    Converted to &quot; + toString(targetType) +</span>
                                   &quot; value '&quot; + result + &quot;'&quot;);
                }
<span class="fc" id="L175">                return targetType.cast(result);</span>
            }
<span class="fc" id="L177">        } catch (final Throwable t) {</span>
<span class="fc" id="L178">            return handleError(targetType, value, t);</span>
        }

    }

    /**
     * Convert the input object into a String.
     * &lt;p&gt;
     * &lt;b&gt;N.B.&lt;/b&gt;This implementation simply uses the value's
     * &lt;code&gt;toString()&lt;/code&gt; method and should be overriden if a
     * more sophisticated mechanism for &lt;i&gt;conversion to a String&lt;/i&gt;
     * is required.
     *
     * @param value The input value to be converted.
     * @return the converted String value.
     * @throws Throwable if an error occurs converting to a String
     */
    protected String convertToString(final Object value) throws Throwable {
<span class="fc" id="L196">        return value.toString();</span>
    }

    /**
     * Convert the input object into an output object of the
     * specified type.
     * &lt;p&gt;
     * Typical implementations will provide a minimum of
     * &lt;code&gt;String --&amp;gt; type&lt;/code&gt; conversion.
     *
     * @param &lt;T&gt; Target type of the conversion.
     * @param type Data type to which this value should be converted.
     * @param value The input value to be converted.
     * @return The converted value.
     * @throws Throwable if an error occurs converting to the specified type
     */
    protected abstract &lt;T&gt; T convertToType(Class&lt;T&gt; type, Object value) throws Throwable;

    /**
     * Return the first element from an Array (or Collection)
     * or the value unchanged if not an Array (or Collection).
     *
     * N.B. This needs to be overriden for array/Collection converters.
     *
     * @param value The value to convert
     * @return The first element in an Array (or Collection)
     * or the value unchanged if not an Array (or Collection)
     */
    protected Object convertArray(final Object value) {
<span class="fc bfc" id="L225" title="All 2 branches covered.">        if (value == null) {</span>
<span class="fc" id="L226">            return null;</span>
        }
<span class="fc bfc" id="L228" title="All 2 branches covered.">        if (value.getClass().isArray()) {</span>
<span class="pc bpc" id="L229" title="1 of 2 branches missed.">            if (Array.getLength(value) &gt; 0) {</span>
<span class="fc" id="L230">                return Array.get(value, 0);</span>
            }
<span class="nc" id="L232">            return null;</span>
        }
<span class="fc bfc" id="L234" title="All 2 branches covered.">        if (value instanceof Collection) {</span>
<span class="fc" id="L235">            final Collection&lt;?&gt; collection = (Collection&lt;?&gt;)value;</span>
<span class="pc bpc" id="L236" title="1 of 2 branches missed.">            if (collection.size() &gt; 0) {</span>
<span class="fc" id="L237">                return collection.iterator().next();</span>
            }
<span class="nc" id="L239">            return null;</span>
        }
<span class="fc" id="L241">        return value;</span>
    }

    /**
     * Handle Conversion Errors.
     * &lt;p&gt;
     * If a default value has been specified then it is returned
     * otherwise a ConversionException is thrown.
     *
     * @param &lt;T&gt; Target type of the conversion.
     * @param type Data type to which this value should be converted.
     * @param value The input value to be converted
     * @param cause The exception thrown by the &lt;code&gt;convert&lt;/code&gt; method
     * @return The default value.
     * @throws ConversionException if no default value has been
     * specified for this {@link Converter}.
     */
    protected &lt;T&gt; T handleError(final Class&lt;T&gt; type, final Object value, final Throwable cause) {
<span class="pc bpc" id="L259" title="1 of 2 branches missed.">        if (log().isDebugEnabled()) {</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">            if (cause instanceof ConversionException) {</span>
<span class="nc" id="L261">                log().debug(&quot;    Conversion threw ConversionException: &quot; + cause.getMessage());</span>
            } else {
<span class="nc" id="L263">                log().debug(&quot;    Conversion threw &quot; + cause);</span>
            }
        }

<span class="fc bfc" id="L267" title="All 2 branches covered.">        if (useDefault) {</span>
<span class="fc" id="L268">            return handleMissing(type);</span>
        }

<span class="fc" id="L271">        ConversionException cex = null;</span>
<span class="fc bfc" id="L272" title="All 2 branches covered.">        if (cause instanceof ConversionException) {</span>
<span class="fc" id="L273">            cex = (ConversionException)cause;</span>
<span class="pc bpc" id="L274" title="1 of 2 branches missed.">            if (log().isDebugEnabled()) {</span>
<span class="nc" id="L275">                log().debug(&quot;    Re-throwing ConversionException: &quot; + cex.getMessage());</span>
<span class="nc" id="L276">                log().debug(&quot;    &quot; + DEFAULT_CONFIG_MSG);</span>
            }
        } else {
<span class="fc" id="L279">            final String msg = &quot;Error converting from '&quot; + toString(value.getClass()) +</span>
<span class="fc" id="L280">                    &quot;' to '&quot; + toString(type) + &quot;' &quot; + cause.getMessage();</span>
<span class="fc" id="L281">            cex = new ConversionException(msg, cause);</span>
<span class="pc bpc" id="L282" title="1 of 2 branches missed.">            if (log().isDebugEnabled()) {</span>
<span class="nc" id="L283">                log().debug(&quot;    Throwing ConversionException: &quot; + msg);</span>
<span class="nc" id="L284">                log().debug(&quot;    &quot; + DEFAULT_CONFIG_MSG);</span>
            }
<span class="fc" id="L286">            BeanUtils.initCause(cex, cause);</span>
        }

<span class="fc" id="L289">        throw cex;</span>

    }

    /**
     * Handle missing values.
     * &lt;p&gt;
     * If a default value has been specified, then it is returned (after a cast
     * to the desired target class); otherwise a ConversionException is thrown.
     *
     * @param &lt;T&gt; the desired target type
     * @param type Data type to which this value should be converted.
     * @return The default value.
     * @throws ConversionException if no default value has been
     * specified for this {@link Converter}.
     */
    protected &lt;T&gt; T handleMissing(final Class&lt;T&gt; type) {

<span class="fc bfc" id="L307" title="All 4 branches covered.">        if (useDefault || type.equals(String.class)) {</span>
<span class="fc" id="L308">            Object value = getDefault(type);</span>
<span class="fc bfc" id="L309" title="All 6 branches covered.">            if (useDefault &amp;&amp; value != null &amp;&amp; !type.equals(value.getClass())) {</span>
                try {
<span class="fc" id="L311">                    value = convertToType(type, defaultValue);</span>
<span class="fc" id="L312">                } catch (final Throwable t) {</span>
<span class="fc" id="L313">                    throw new ConversionException(&quot;Default conversion to &quot; + toString(type)</span>
                            + &quot; failed.&quot;, t);
<span class="fc" id="L315">                }</span>
            }
<span class="pc bpc" id="L317" title="1 of 2 branches missed.">            if (log().isDebugEnabled()) {</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">                log().debug(&quot;    Using default &quot;</span>
<span class="nc" id="L319">                        + (value == null ? &quot;&quot; : toString(value.getClass()) + &quot; &quot;)</span>
                        + &quot;value '&quot; + defaultValue + &quot;'&quot;);
            }
            // value is now either null or of the desired target type
<span class="fc" id="L323">            return type.cast(value);</span>
        }

<span class="fc" id="L326">        final ConversionException cex =  new ConversionException(&quot;No value specified for '&quot; +</span>
<span class="fc" id="L327">                toString(type) + &quot;'&quot;);</span>
<span class="pc bpc" id="L328" title="1 of 2 branches missed.">        if (log().isDebugEnabled()) {</span>
<span class="nc" id="L329">            log().debug(&quot;    Throwing ConversionException: &quot; + cex.getMessage());</span>
<span class="nc" id="L330">            log().debug(&quot;    &quot; + DEFAULT_CONFIG_MSG);</span>
        }
<span class="fc" id="L332">        throw cex;</span>

    }

    /**
     * Set the default value, converting as required.
     * &lt;p&gt;
     * If the default value is different from the type the
     * &lt;code&gt;Converter&lt;/code&gt; handles, it will be converted
     * to the handled type.
     *
     * @param defaultValue The default value to be returned
     * if the value to be converted is missing or an error
     * occurs converting the value.
     * @throws ConversionException if an error occurs converting
     * the default value
     */
    protected void setDefaultValue(final Object defaultValue) {
<span class="fc" id="L350">        useDefault = false;</span>
<span class="pc bpc" id="L351" title="1 of 2 branches missed.">        if (log().isDebugEnabled()) {</span>
<span class="nc" id="L352">            log().debug(&quot;Setting default value: &quot; + defaultValue);</span>
        }
<span class="fc bfc" id="L354" title="All 2 branches covered.">        if (defaultValue == null) {</span>
<span class="fc" id="L355">           this.defaultValue  = null;</span>
        } else {
<span class="fc" id="L357">           this.defaultValue  = convert(getDefaultType(), defaultValue);</span>
        }
<span class="fc" id="L359">        useDefault = true;</span>
<span class="fc" id="L360">    }</span>

    /**
     * Return the default type this &lt;code&gt;Converter&lt;/code&gt; handles.
     *
     * @return The default type this &lt;code&gt;Converter&lt;/code&gt; handles.
     */
    protected abstract Class&lt;?&gt; getDefaultType();

    /**
     * Return the default value for conversions to the specified
     * type.
     * @param type Data type to which this value should be converted.
     * @return The default value for the specified type.
     */
    protected Object getDefault(final Class&lt;?&gt; type) {
<span class="fc bfc" id="L376" title="All 2 branches covered.">        if (type.equals(String.class)) {</span>
<span class="fc" id="L377">            return null;</span>
        }
<span class="fc" id="L379">        return defaultValue;</span>
    }

    /**
     * Provide a String representation of this converter.
     *
     * @return A String representation of this converter
     */
    @Override
    public String toString() {
<span class="fc" id="L389">        return toString(getClass()) + &quot;[UseDefault=&quot; + useDefault + &quot;]&quot;;</span>
    }

    // ----------------------------------------------------------- Package Methods

    /**
     * Accessor method for Log instance.
     * &lt;p&gt;
     * The Log instance variable is transient and
     * accessing it through this method ensures it
     * is re-initialized when this instance is
     * de-serialized.
     *
     * @return The Log instance.
     */
    Log log() {
<span class="fc bfc" id="L405" title="All 2 branches covered.">        if (log == null) {</span>
<span class="fc" id="L406">            log = LogFactory.getLog(getClass());</span>
        }
<span class="fc" id="L408">        return log;</span>
    }

    /**
     * Provide a String representation of a &lt;code&gt;java.lang.Class&lt;/code&gt;.
     * @param type The &lt;code&gt;java.lang.Class&lt;/code&gt;.
     * @return The String representation.
     */
    String toString(final Class&lt;?&gt; type) {
<span class="fc" id="L417">        String typeName = null;</span>
<span class="pc bpc" id="L418" title="1 of 2 branches missed.">        if (type == null) {</span>
<span class="nc" id="L419">            typeName = &quot;null&quot;;</span>
<span class="pc bpc" id="L420" title="1 of 2 branches missed.">        } else if (type.isArray()) {</span>
<span class="nc" id="L421">            Class&lt;?&gt; elementType = type.getComponentType();</span>
<span class="nc" id="L422">            int count = 1;</span>
<span class="nc bnc" id="L423" title="All 2 branches missed.">            while (elementType.isArray()) {</span>
<span class="nc" id="L424">                elementType = elementType .getComponentType();</span>
<span class="nc" id="L425">                count++;</span>
            }
<span class="nc" id="L427">            typeName = elementType.getName();</span>
<span class="nc bnc" id="L428" title="All 2 branches missed.">            for (int i = 0; i &lt; count; i++) {</span>
<span class="nc" id="L429">                typeName += &quot;[]&quot;;</span>
            }
<span class="nc" id="L431">        } else {</span>
<span class="fc" id="L432">            typeName = type.getName();</span>
        }
<span class="fc bfc" id="L434" title="All 2 branches covered.">        if (typeName.startsWith(&quot;java.lang.&quot;) ||</span>
<span class="fc bfc" id="L435" title="All 2 branches covered.">            typeName.startsWith(&quot;java.util.&quot;) ||</span>
<span class="fc bfc" id="L436" title="All 2 branches covered.">            typeName.startsWith(&quot;java.math.&quot;)) {</span>
<span class="fc" id="L437">            typeName = typeName.substring(&quot;java.lang.&quot;.length());</span>
<span class="fc bfc" id="L438" title="All 2 branches covered.">        } else if (typeName.startsWith(PACKAGE)) {</span>
<span class="fc" id="L439">            typeName = typeName.substring(PACKAGE.length());</span>
        }
<span class="fc" id="L441">        return typeName;</span>
    }

    /**
     * Performs a conversion to the default type. This method is called if we do
     * not have a target class. In this case, the T parameter is not set.
     * Therefore, we can cast to it (which is required to fulfill the contract
     * of the method signature).
     *
     * @param &lt;T&gt; the type of the result object
     * @param targetClass the target class of the conversion
     * @param value the value to be converted
     * @return the converted value
     */
    private &lt;T&gt; T convertToDefaultType(final Class&lt;T&gt; targetClass, final Object value) {
        @SuppressWarnings(&quot;unchecked&quot;)
        final
<span class="fc" id="L458">        T result = (T) convert(getDefaultType(), value);</span>
<span class="fc" id="L459">        return result;</span>
    }

    /**
     * Generates a standard conversion exception with a message indicating that
     * the passed in value cannot be converted to the desired target type.
     *
     * @param type the target type
     * @param value the value to be converted
     * @return a {@code ConversionException} with a standard message
     * @since 1.9
     */
    protected ConversionException conversionException(final Class&lt;?&gt; type, final Object value) {
<span class="fc" id="L472">        return new ConversionException(&quot;Can't convert value '&quot; + value</span>
                + &quot;' to type &quot; + type);
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>