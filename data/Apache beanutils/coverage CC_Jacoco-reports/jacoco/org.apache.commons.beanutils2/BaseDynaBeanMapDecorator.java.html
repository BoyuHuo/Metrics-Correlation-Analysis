<?xml version="1.0" encoding="utf-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BaseDynaBeanMapDecorator.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Apache Commons BeanUtils</a> &gt; <a href="index.source.html" class="el_package">org.apache.commons.beanutils2</a> &gt; <span class="el_source">BaseDynaBeanMapDecorator.java</span></div><h1>BaseDynaBeanMapDecorator.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the &quot;License&quot;); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.apache.commons.beanutils2;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;

/**
 * &lt;p&gt;A base class for decorators providing &lt;code&gt;Map&lt;/code&gt; behavior on
 * {@link DynaBean}s.&lt;/p&gt;
 *
 * &lt;p&gt;The motivation for this implementation is to provide access to {@link DynaBean}
 *    properties in technologies that are unaware of BeanUtils and {@link DynaBean}s -
 *    such as the expression languages of JSTL and JSF.&lt;/p&gt;
 *
 * &lt;p&gt;This rather technical base class implements the methods of the
 *    {@code Map} interface on top of a {@code DynaBean}. It was introduced
 *    to handle generic parameters in a meaningful way without breaking
 *    backwards compatibility of the 1.x {@code DynaBeanMapDecorator} class: A
 *    map wrapping a {@code DynaBean} should be of type {@code Map&lt;String, Object&gt;}.
 *    However, when using these generic parameters in {@code DynaBeanMapDecorator}
 *    this would be an incompatible change (as method signatures would have to
 *    be adapted). To solve this problem, this generic base class is added
 *    which allows specifying the key type as parameter. This makes it easy to
 *    have a new subclass using the correct generic parameters while
 *    {@code DynaBeanMapDecorator} could still remain with compatible
 *    parameters.&lt;/p&gt;
 *
 * @param &lt;K&gt; the type of the keys in the decorated map
 * @since BeanUtils 1.9.0
 * @version $Id$
 */
public abstract class BaseDynaBeanMapDecorator&lt;K&gt; implements Map&lt;K, Object&gt; {

    private final DynaBean dynaBean;
    private final boolean readOnly;
    private transient Set&lt;K&gt; keySet;

    // ------------------- Constructors ----------------------------------

    /**
     * Constructs a read only Map for the specified
     * {@link DynaBean}.
     *
     * @param dynaBean The dyna bean being decorated
     * @throws IllegalArgumentException if the {@link DynaBean} is null.
     */
    public BaseDynaBeanMapDecorator(final DynaBean dynaBean) {
<span class="fc" id="L68">        this(dynaBean, true);</span>
<span class="fc" id="L69">    }</span>

    /**
     * Construct a Map for the specified {@link DynaBean}.
     *
     * @param dynaBean The dyna bean being decorated
     * @param readOnly &lt;code&gt;true&lt;/code&gt; if the Map is read only
     * otherwise &lt;code&gt;false&lt;/code&gt;
     * @throws IllegalArgumentException if the {@link DynaBean} is null.
     */
<span class="fc" id="L79">    public BaseDynaBeanMapDecorator(final DynaBean dynaBean, final boolean readOnly) {</span>
<span class="pc bpc" id="L80" title="1 of 2 branches missed.">        if (dynaBean == null) {</span>
<span class="nc" id="L81">            throw new IllegalArgumentException(&quot;DynaBean is null&quot;);</span>
        }
<span class="fc" id="L83">        this.dynaBean = dynaBean;</span>
<span class="fc" id="L84">        this.readOnly = readOnly;</span>
<span class="fc" id="L85">    }</span>


    // ------------------- public Methods --------------------------------


    /**
     * Indicate whether the Map is read only.
     *
     * @return &lt;code&gt;true&lt;/code&gt; if the Map is read only,
     * otherwise &lt;code&gt;false&lt;/code&gt;.
     */
    public boolean isReadOnly() {
<span class="fc" id="L98">        return readOnly;</span>
    }

    // ------------------- java.util.Map Methods -------------------------

    /**
     * clear() operation is not supported.
     *
     * @throws UnsupportedOperationException This operation is not yet supported
     */
    @Override
    public void clear() {
<span class="fc" id="L110">        throw new UnsupportedOperationException();</span>
    }

    /**
     * Indicate whether the {@link DynaBean} contains a specified
     * value for one (or more) of its properties.
     *
     * @param key The {@link DynaBean}'s property name
     * @return &lt;code&gt;true&lt;/code&gt; if one of the {@link DynaBean}'s
     * properties contains a specified value.
     */
    @Override
    public boolean containsKey(final Object key) {
<span class="fc" id="L123">        final DynaClass dynaClass = getDynaBean().getDynaClass();</span>
<span class="fc" id="L124">        final DynaProperty dynaProperty = dynaClass.getDynaProperty(toString(key));</span>
<span class="fc bfc" id="L125" title="All 2 branches covered.">        return dynaProperty == null ? false : true;</span>
    }

    /**
     * Indicates whether the decorated {@link DynaBean} contains
     * a specified value.
     *
     * @param value The value to check for.
     * @return &lt;code&gt;true&lt;/code&gt; if one of the the {@link DynaBean}'s
     * properties contains the specified value, otherwise
     * &lt;code&gt;false&lt;/code&gt;.
     */
    @Override
    public boolean containsValue(final Object value) {
<span class="fc" id="L139">        final DynaProperty[] properties = getDynaProperties();</span>
<span class="fc bfc" id="L140" title="All 2 branches covered.">        for (final DynaProperty propertie : properties) {</span>
<span class="fc" id="L141">            final String key = propertie.getName();</span>
<span class="fc" id="L142">            final Object prop = getDynaBean().get(key);</span>
<span class="pc bpc" id="L143" title="1 of 2 branches missed.">            if (value == null) {</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">                if (prop == null) {</span>
<span class="nc" id="L145">                    return true;</span>
                }
            } else {
<span class="fc bfc" id="L148" title="All 2 branches covered.">                if (value.equals(prop)) {</span>
<span class="fc" id="L149">                    return true;</span>
                }
            }
        }
<span class="fc" id="L153">        return false;</span>
    }

    /**
     * &lt;p&gt;Returns the Set of the property/value mappings
     * in the decorated {@link DynaBean}.&lt;/p&gt;
     *
     * &lt;p&gt;Each element in the Set is a &lt;code&gt;Map.Entry&lt;/code&gt;
     * type.&lt;/p&gt;
     *
     * @return An unmodifiable set of the DynaBean
     * property name/value pairs
     */
    @Override
    public Set&lt;Map.Entry&lt;K, Object&gt;&gt; entrySet() {
<span class="fc" id="L168">        final DynaProperty[] properties = getDynaProperties();</span>
<span class="fc" id="L169">        final Set&lt;Map.Entry&lt;K, Object&gt;&gt; set = new HashSet&lt;&gt;(properties.length);</span>
<span class="fc bfc" id="L170" title="All 2 branches covered.">        for (final DynaProperty propertie : properties) {</span>
<span class="fc" id="L171">            final K key = convertKey(propertie.getName());</span>
<span class="fc" id="L172">            final Object value = getDynaBean().get(propertie.getName());</span>
<span class="fc" id="L173">            set.add(new MapEntry&lt;&gt;(key, value));</span>
        }
<span class="fc" id="L175">        return Collections.unmodifiableSet(set);</span>
    }

    /**
     * Return the value for the specified key from
     * the decorated {@link DynaBean}.
     *
     * @param key The {@link DynaBean}'s property name
     * @return The value for the specified property.
     */
    @Override
    public Object get(final Object key) {
<span class="fc" id="L187">        return getDynaBean().get(toString(key));</span>
    }

    /**
     * Indicate whether the decorated {@link DynaBean} has
     * any properties.
     *
     * @return &lt;code&gt;true&lt;/code&gt; if the {@link DynaBean} has
     * no properties, otherwise &lt;code&gt;false&lt;/code&gt;.
     */
    @Override
    public boolean isEmpty() {
<span class="fc bfc" id="L199" title="All 2 branches covered.">        return getDynaProperties().length == 0;</span>
    }

    /**
     * &lt;p&gt;Returns the Set of the property
     * names in the decorated {@link DynaBean}.&lt;/p&gt;
     *
     * &lt;p&gt;&lt;b&gt;N.B.&lt;/b&gt;For {@link DynaBean}s whose associated {@link DynaClass}
     * is a {@link MutableDynaClass} a new Set is created every
     * time, otherwise the Set is created only once and cached.&lt;/p&gt;
     *
     * @return An unmodifiable set of the {@link DynaBean}s
     * property names.
     */
    @Override
    public Set&lt;K&gt; keySet() {
<span class="pc bpc" id="L215" title="1 of 2 branches missed.">        if (keySet != null) {</span>
<span class="nc" id="L216">            return keySet;</span>
        }

        // Create a Set of the keys
<span class="fc" id="L220">        final DynaProperty[] properties = getDynaProperties();</span>
<span class="fc" id="L221">        Set&lt;K&gt; set = new HashSet&lt;&gt;(properties.length);</span>
<span class="fc bfc" id="L222" title="All 2 branches covered.">        for (final DynaProperty propertie : properties) {</span>
<span class="fc" id="L223">            set.add(convertKey(propertie.getName()));</span>
        }
<span class="fc" id="L225">        set = Collections.unmodifiableSet(set);</span>

        // Cache the keySet if Not a MutableDynaClass
<span class="fc" id="L228">        final DynaClass dynaClass = getDynaBean().getDynaClass();</span>
<span class="pc bpc" id="L229" title="1 of 2 branches missed.">        if (!(dynaClass instanceof MutableDynaClass)) {</span>
<span class="fc" id="L230">            keySet = set;</span>
        }

<span class="fc" id="L233">        return set;</span>

    }

    /**
     * Set the value for the specified property in
     * the decorated {@link DynaBean}.
     *
     * @param key The {@link DynaBean}'s property name
     * @param value The value for the specified property.
     * @return The previous property's value.
     * @throws UnsupportedOperationException if
     * &lt;code&gt;isReadOnly()&lt;/code&gt; is true.
     */
    @Override
    public Object put(final K key, final Object value) {
<span class="fc bfc" id="L249" title="All 2 branches covered.">        if (isReadOnly()) {</span>
<span class="fc" id="L250">            throw new UnsupportedOperationException(&quot;Map is read only&quot;);</span>
        }
<span class="fc" id="L252">        final String property = toString(key);</span>
<span class="fc" id="L253">        final Object previous = getDynaBean().get(property);</span>
<span class="fc" id="L254">        getDynaBean().set(property, value);</span>
<span class="fc" id="L255">        return previous;</span>
    }

    /**
     * Copy the contents of a Map to the decorated {@link DynaBean}.
     *
     * @param map The Map of values to copy.
     * @throws UnsupportedOperationException if
     * &lt;code&gt;isReadOnly()&lt;/code&gt; is true.
     */
    @Override
    public void putAll(final Map&lt;? extends K, ? extends Object&gt; map) {
<span class="fc bfc" id="L267" title="All 2 branches covered.">        if (isReadOnly()) {</span>
<span class="fc" id="L268">            throw new UnsupportedOperationException(&quot;Map is read only&quot;);</span>
        }
<span class="fc bfc" id="L270" title="All 2 branches covered.">        for (final Map.Entry&lt;? extends K, ?&gt; e : map.entrySet()) {</span>
<span class="fc" id="L271">            put(e.getKey(), e.getValue());</span>
<span class="fc" id="L272">        }</span>
<span class="fc" id="L273">    }</span>

    /**
     * remove() operation is not supported.
     *
     * @param key The {@link DynaBean}'s property name
     * @return the value removed
     * @throws UnsupportedOperationException This operation is not yet supported
     */
    @Override
    public Object remove(final Object key) {
<span class="fc" id="L284">        throw new UnsupportedOperationException();</span>
    }

    /**
     * Returns the number properties in the decorated
     * {@link DynaBean}.
     * @return The number of properties.
     */
    @Override
    public int size() {
<span class="fc" id="L294">        return getDynaProperties().length;</span>
    }

    /**
     * Returns the set of property values in the
     * decorated {@link DynaBean}.
     *
     * @return Unmodifiable collection of values.
     */
    @Override
    public Collection&lt;Object&gt; values() {
<span class="fc" id="L305">        final DynaProperty[] properties = getDynaProperties();</span>
<span class="fc" id="L306">        final List&lt;Object&gt; values = new ArrayList&lt;&gt;(properties.length);</span>
<span class="fc bfc" id="L307" title="All 2 branches covered.">        for (final DynaProperty propertie : properties) {</span>
<span class="fc" id="L308">            final String key = propertie.getName();</span>
<span class="fc" id="L309">            final Object value = getDynaBean().get(key);</span>
<span class="fc" id="L310">            values.add(value);</span>
        }
<span class="fc" id="L312">        return Collections.unmodifiableList(values);</span>
    }

    // ------------------- protected Methods -----------------------------

    /**
     * Provide access to the underlying {@link DynaBean}
     * this Map decorates.
     *
     * @return the decorated {@link DynaBean}.
     */
    public DynaBean getDynaBean() {
<span class="fc" id="L324">        return dynaBean;</span>
    }

    /**
     * Converts the name of a property to the key type of this decorator.
     *
     * @param propertyName the name of a property
     * @return the converted key to be used in the decorated map
     */
    protected abstract K convertKey(String propertyName);

    // ------------------- private Methods -------------------------------

    /**
     * Convenience method to retrieve the {@link DynaProperty}s
     * for this {@link DynaClass}.
     *
     * @return The an array of the {@link DynaProperty}s.
     */
    private DynaProperty[] getDynaProperties() {
<span class="fc" id="L344">        return getDynaBean().getDynaClass().getDynaProperties();</span>
    }

    /**
     * Convenience method to convert an Object
     * to a String.
     *
     * @param obj The Object to convert
     * @return String representation of the object
     */
    private String toString(final Object obj) {
<span class="pc bpc" id="L355" title="1 of 2 branches missed.">        return obj == null ? null : obj.toString();</span>
    }

    /**
     * Map.Entry implementation.
     */
    private static class MapEntry&lt;K&gt; implements Map.Entry&lt;K, Object&gt; {
        private final K key;
        private final Object value;
<span class="fc" id="L364">        MapEntry(final K key, final Object value) {</span>
<span class="fc" id="L365">            this.key = key;</span>
<span class="fc" id="L366">            this.value = value;</span>
<span class="fc" id="L367">        }</span>
        @Override
        public boolean equals(final Object o) {
<span class="nc bnc" id="L370" title="All 2 branches missed.">            if (!(o instanceof Map.Entry)) {</span>
<span class="nc" id="L371">                return false;</span>
            }
<span class="nc" id="L373">            final Map.Entry&lt;?, ?&gt; e = (Map.Entry&lt;?, ?&gt;)o;</span>
<span class="nc bnc" id="L374" title="All 4 branches missed.">            return key.equals(e.getKey()) &amp;&amp;</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">                    (value == null ? e.getValue() == null</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">                                   : value.equals(e.getValue()));</span>
        }
        @Override
        public int hashCode() {
<span class="fc bfc" id="L380" title="All 2 branches covered.">            return key.hashCode() + (value == null ? 0 : value.hashCode());</span>
        }
        @Override
        public K getKey() {
<span class="fc" id="L384">            return key;</span>
        }
        @Override
        public Object getValue() {
<span class="fc" id="L388">            return value;</span>
        }
        @Override
        public Object setValue(final Object value) {
<span class="nc" id="L392">            throw new UnsupportedOperationException();</span>
        }
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>