<?xml version="1.0" encoding="utf-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ContextClassLoaderLocal.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Apache Commons BeanUtils</a> &gt; <a href="index.source.html" class="el_package">org.apache.commons.beanutils2</a> &gt; <span class="el_source">ContextClassLoaderLocal.java</span></div><h1>ContextClassLoaderLocal.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the &quot;License&quot;); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.apache.commons.beanutils2;

import java.util.Map;
import java.util.WeakHashMap;

/**
 * An instance of this class represents a value that is provided per (thread)
 * context classloader.
 *
 * &lt;p&gt;Occasionally it is necessary to store data in &quot;global&quot; variables
 * (including uses of the Singleton pattern). In applications which have only
 * a single classloader such data can simply be stored as &quot;static&quot; members on
 * some class. When multiple classloaders are involved, however, this approach
 * can fail; in particular, this doesn't work when the code may be run within a
 * servlet container or a j2ee container, and the class on which the static
 * member is defined is loaded via a &quot;shared&quot; classloader that is visible to all
 * components running within the container. This class provides a mechanism for
 * associating data with a ClassLoader instance, which ensures that when the
 * code runs in such a container each component gets its own copy of the
 * &quot;global&quot; variable rather than unexpectedly sharing a single copy of the
 * variable with other components that happen to be running in the same
 * container at the same time (eg servlets or EJBs.)&lt;/p&gt;
 *
 * &lt;p&gt;This class is strongly patterned after the java.lang.ThreadLocal
 * class, which performs a similar task in allowing data to be associated
 * with a particular thread.&lt;/p&gt;
 *
 * &lt;p&gt;When code that uses this class is run as a &quot;normal&quot; application, ie
 * not within a container, the effect is identical to just using a static
 * member variable to store the data, because Thread.getContextClassLoader
 * always returns the same classloader (the system classloader).&lt;/p&gt;
 *
 * &lt;p&gt;Expected usage is as follows:&lt;/p&gt;
 * &lt;pre&gt;
 * &lt;code&gt;
 *  public class SomeClass {
 *    private static final ContextClassLoaderLocal&amp;lt;String&amp;gt; global
 *      = new ContextClassLoaderLocal&amp;lt;String&amp;gt;() {
 *          protected String initialValue() {
 *              return new String(&quot;Initial value&quot;);
 *          };
 *
 *    public void testGlobal() {
 *      String s = global.get();
 *      System.out.println(&quot;global value:&quot; + s);
 *      buf.set(&quot;New Value&quot;);
 *    }
 * &lt;/code&gt;
 * &lt;/pre&gt;
 *
 * &lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; This class takes some care to ensure that when
 * a component which uses this class is &quot;undeployed&quot; by a container the
 * component-specific classloader and all its associated classes (and their
 * static variables) are garbage-collected. Unfortunately there is one
 * scenario in which this does &lt;i&gt;not&lt;/i&gt; work correctly and there
 * is unfortunately no known workaround other than ensuring that the
 * component (or its container) calls the &quot;unset&quot; method on this class for
 * each instance of this class when the component is undeployed. The problem
 * occurs if:
 * &lt;ul&gt;
 * &lt;li&gt;the class containing a static instance of this class was loaded via
 * a shared classloader, and&lt;/li&gt;
 * &lt;li&gt;the value stored in the instance is an object whose class was loaded
 * via the component-specific classloader (or any of the objects it refers
 * to were loaded via that classloader).&lt;/li&gt;
 * &lt;/ul&gt;
 * &lt;p&gt;The result is that the map managed by this object still contains a strong
 * reference to the stored object, which contains a strong reference to the
 * classloader that loaded it, meaning that although the container has
 * &quot;undeployed&quot; the component the component-specific classloader and all the
 * related classes and static variables cannot be garbage-collected. This is
 * not expected to be an issue with the commons-beanutils library as the only
 * classes which use this class are BeanUtilsBean and ConvertUtilsBean and
 * there is no obvious reason for a user of the beanutils library to subclass
 * either of those classes.&lt;/p&gt;
 *
 * &lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; A WeakHashMap bug in several 1.3 JVMs results in
 * a memory leak for those JVMs.&lt;/p&gt;
 *
 * &lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; Of course all of this would be unnecessary if
 * containers required each component to load the full set of classes it
 * needs, ie avoided providing classes loaded via a &quot;shared&quot; classloader.&lt;/p&gt;
 *
 * @param &lt;T&gt; the type of data stored in an instance
 * @version $Id$
 * @see java.lang.Thread#getContextClassLoader
 */
public class ContextClassLoaderLocal&lt;T&gt; {
<span class="fc" id="L106">    private final Map&lt;ClassLoader, T&gt; valueByClassLoader = new WeakHashMap&lt;&gt;();</span>
<span class="fc" id="L107">    private boolean globalValueInitialized = false;</span>
    private T globalValue;

    /**
     * Construct a context classloader instance
     */
    public ContextClassLoaderLocal() {
<span class="fc" id="L114">        super();</span>
<span class="fc" id="L115">    }</span>

    /**
     * Returns the initial value for this ContextClassLoaderLocal
     * variable. This method will be called once per Context ClassLoader for
     * each ContextClassLoaderLocal, the first time it is accessed
     * with get or set.  If the programmer desires ContextClassLoaderLocal variables
     * to be initialized to some value other than null, ContextClassLoaderLocal must
     * be subclassed, and this method overridden.  Typically, an anonymous
     * inner class will be used.  Typical implementations of initialValue
     * will call an appropriate constructor and return the newly constructed
     * object.
     *
     * @return a new Object to be used as an initial value for this ContextClassLoaderLocal
     */
    protected T initialValue() {
<span class="fc" id="L131">        return null;</span>
    }

    /**
     * Gets the instance which provides the functionality for {@link BeanUtils}.
     * This is a pseudo-singleton - an single instance is provided per (thread) context classloader.
     * This mechanism provides isolation for web apps deployed in the same container.
     * @return the object currently associated with the context-classloader of the current thread.
     */
    public synchronized T get() {
        // synchronizing the whole method is a bit slower
        // but guarantees no subtle threading problems, and there's no
        // need to synchronize valueByClassLoader

        // make sure that the map is given a change to purge itself
<span class="fc" id="L146">        valueByClassLoader.isEmpty();</span>
        try {

<span class="fc" id="L149">            final ClassLoader contextClassLoader = Thread.currentThread().getContextClassLoader();</span>
<span class="pc bpc" id="L150" title="1 of 2 branches missed.">            if (contextClassLoader != null) {</span>

<span class="fc" id="L152">                T value = valueByClassLoader.get(contextClassLoader);</span>
<span class="fc bfc" id="L153" title="All 2 branches covered.">                if (value == null</span>
<span class="pc bpc" id="L154" title="1 of 2 branches missed.">                &amp;&amp; !valueByClassLoader.containsKey(contextClassLoader)) {</span>
<span class="fc" id="L155">                    value = initialValue();</span>
<span class="fc" id="L156">                    valueByClassLoader.put(contextClassLoader, value);</span>
                }
<span class="fc" id="L158">                return value;</span>

            }

<span class="nc" id="L162">        } catch (final SecurityException e) { /* SWALLOW - should we log this? */ }</span>

        // if none or exception, return the globalValue
<span class="nc bnc" id="L165" title="All 2 branches missed.">        if (!globalValueInitialized) {</span>
<span class="nc" id="L166">            globalValue = initialValue();</span>
<span class="nc" id="L167">            globalValueInitialized = true;</span>
        }//else already set
<span class="nc" id="L169">        return globalValue;</span>
    }

    /**
     * Sets the value - a value is provided per (thread) context classloader.
     * This mechanism provides isolation for web apps deployed in the same container.
     *
     * @param value the object to be associated with the entrant thread's context classloader
     */
    public synchronized void set(final T value) {
        // synchronizing the whole method is a bit slower
        // but guarentees no subtle threading problems

        // make sure that the map is given a change to purge itself
<span class="fc" id="L183">        valueByClassLoader.isEmpty();</span>
        try {

<span class="fc" id="L186">            final ClassLoader contextClassLoader = Thread.currentThread().getContextClassLoader();</span>
<span class="pc bpc" id="L187" title="1 of 2 branches missed.">            if (contextClassLoader != null) {</span>
<span class="fc" id="L188">                valueByClassLoader.put(contextClassLoader, value);</span>
<span class="fc" id="L189">                return;</span>
            }

<span class="nc" id="L192">        } catch (final SecurityException e) { /* SWALLOW - should we log this? */ }</span>

        // if in doubt, set the global value
<span class="nc" id="L195">        globalValue = value;</span>
<span class="nc" id="L196">        globalValueInitialized = true;</span>
<span class="nc" id="L197">    }</span>

    /**
     * Unsets the value associated with the current thread's context classloader
     */
    public synchronized void unset() {
        try {

<span class="fc" id="L205">            final ClassLoader contextClassLoader = Thread.currentThread().getContextClassLoader();</span>
<span class="fc" id="L206">            unset(contextClassLoader);</span>

<span class="pc" id="L208">        } catch (final SecurityException e) { /* SWALLOW - should we log this? */ }</span>
<span class="fc" id="L209">    }</span>

    /**
     * Unsets the value associated with the given classloader
     * @param classLoader The classloader to &lt;i&gt;unset&lt;/i&gt; for
     */
    public synchronized void unset(final ClassLoader classLoader) {
<span class="fc" id="L216">        valueByClassLoader.remove(classLoader);</span>
<span class="fc" id="L217">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>